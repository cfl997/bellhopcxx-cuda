#include <iostream>
#include <vector>
#include <thread>
#include <chrono>
#include <string>
#include <filesystem>
#include <cmath>
#include <algorithm>

#include "TEDSbellhop/TEDSbellhop.hpp"
#include "tl_png.hpp"

#ifdef _WIN32
#define NOMINMAX
#include <windows.h>
#endif

// 最终版：根据用户提供的完整 2D SSP 矩阵进行测试
// - 使用用户指定的非均匀水平距离网格，并进行 15% 的拉伸。
// - 直接填充用户提供的 c(z,r) 声速矩阵。
// - 规避 TEDSbellhop 库的 Q-SSP 实现 bug。

static tedsbellhop::TL2DInput create_base_input_from_user_matrix()
{
    using namespace tedsbellhop;

    TL2DInput in;

    in.title   = "TEDSbellhop Test with User-Provided 2D SSP Matrix";
    in.freq_hz = 1000.0;
    in.options = "Q";

    in.run_type.use_raw = false;
    in.run_type.tl   = TLCoherence::Incoherent;
    in.run_type.infl = Influence::GeomGaussianCartesian;

    //in.prt_callback = [](const char*) {};
    //in.output_callback = [](const char*) {};

    // -----------------------------
    // 1) 射线
    // -----------------------------
    in.n_rays = 2000;
    in.start_angle_deg = -90.0;
    in.end_angle_deg   = 90.0;

    // -----------------------------
    // 2) TL 输出网格 (0..100km, 0..5000m)
    // -----------------------------
    // 0..100000m，步长 100m -> 1001 个点
    in.pos.receiver_ranges.resize(1001);
    for(int i = 0; i < 1001; ++i) in.pos.receiver_ranges[i] = float(i) * 100.0f;
    in.pos.receiver_depths_m.resize(501);
    for(int i = 0; i < 501; ++i) in.pos.receiver_depths_m[i] = float(i) * 10.0f;


    // -----------------------------
    // 4) box & deltas
    // -----------------------------
    in.beam.box_x_m = 100000.0;
    in.beam.box_z_m = 6000.0;
    in.beam.deltas_m = 50.0;

    // -----------------------------
    // 3) 边界
    // -----------------------------
    // 确保 top_curve 范围足够大，能覆盖 100km 计算域
    double max_ssp_range_m = 150.0 * 1000.0; // 150km in meters
    double min_ssp_range_m = -max_ssp_range_m;

    in.boundaries.top.bc = BoundaryCondition::Vacuum;
    in.boundaries.bottom.bc = BoundaryCondition::Rigid;
    in.boundaries.top_curve.r = {min_ssp_range_m, max_ssp_range_m};
    in.boundaries.top_curve.z = {0.0, 0.0};
    in.boundaries.bottom_curve.interp = BoundaryInterp::Linear;
    // 参考其他测试用例的写法：用一个“平滑起伏”的合成海底，确保：
    // - 覆盖 0..box_x_m（这里 0..10000m）
    // - 不引入很陡的折线，避免数值/几何问题
    
    // - 深度整体落在 box_z_m 之内（这里 box_z_m=6000m，所以海底选 ~5200m 左右）

    in.beam.box_x_m = 100000;

    const int Nb = 500;
    in.boundaries.bottom_curve.r.resize(Nb);
    in.boundaries.bottom_curve.z.resize(Nb);

    const double base_bot = 4200.0;                // 平均海底深度（m）
    const double A1 = 350.0;                      // 主起伏幅度（m）
    const double A2 = 200;                       // 次起伏幅度（m）
    constexpr double kPi = 3.14159265358979323846;

    for (int i = 0; i < Nb; ++i) {
        double t = (Nb == 1) ? 0.0 : double(i) / double(Nb - 1);
        double rr = in.beam.box_x_m * t;           // 0..box_x_m

        // 两个频率叠加 + 相位偏移
        double und = A1 * std::sin(2.0 * kPi * t)
                   + A2 * std::sin(2.0 * kPi * 3.0 * t + 0.7);

        in.boundaries.bottom_curve.r[i] = rr;
        in.boundaries.bottom_curve.z[i] = base_bot + und;
    }



    // -----------------------------
    // 5) Q-SSP (2D) - 直接使用用户提供的矩阵
    // -----------------------------
    in.ssp.type = SSPType::Quad;

    // 水平距离网格 (m)
    // 注意：这里必须用米；原始数据是 km，需要 *1000。
    in.ssp_quad.ranges = {
        -115.6155f * 1000.0f,
        0.0f,
        2.0f * 1000.0f,
        4.0f * 1000.0f,
        6.0f * 1000.0f,
        8.0f * 1000.0f,
        10.0f * 1000.0f,
        12.0f * 1000.0f,
        14.0f * 1000.0f,
        16.0f * 1000.0f,
        18.0f * 1000.0f,
        20.0f * 1000.0f,
        22.0f * 1000.0f,
        24.0f * 1000.0f,
        26.0f * 1000.0f,
        28.0f * 1000.0f,
        30.0f * 1000.0f,
        115.6155f * 1000.0f
    };
    in.ssp_quad.ranges_in_km = false;

    // 深度网格 (m)
    // 使用你给的原始 52 个深度点（与原始声速矩阵行数一致）
    const std::vector<float> ssp_depths = {
        0, 1, 2, 3, 5, 6, 7, 9, 11, 13, 15, 18, 21, 25, 29, 34, 40, 47, 55, 65, 77,
        92, 109, 130, 155, 186, 222, 266, 318, 380, 453, 541, 643, 763, 902, 1062,
        1245, 1452, 1684, 1941, 2225, 2533, 2865, 3220, 3597, 3992, 4405, 4833,
        5274, 5727
    };
    in.ssp_quad.depths_m = ssp_depths;

    // 声速矩阵 c(z,r)
    // 维度：height=52（depth），width=18（range）
    // 布局：row-major：c[depth_index * width + range_index]
    const std::vector<float> ssp_c_matrix = {
        // TODO: 粘贴你提供的 52x18 声速矩阵（共 936 个值），按“每行 18 个值”依次展开
        1536.4847412109375,            1536.4847412109375,            1536.3807373046875,              1536.28369140625,             1535.962646484375,            1535.7271728515625,           1535.5235595703125,            1535.206298828125,            1534.947021484375,            1534.518798828125,           1534.0545654296875,            1533.914794921875,               1533.587890625,            1533.491943359375,           1533.1319580078125,           1532.9903564453125,           1532.5994873046875,           1532.5994873046875,
             1536.51171875,                 1536.51171875,              1536.40478515625,            1536.3065185546875,            1535.9825439453125,            1535.7457275390625,            1535.539794921875,            1535.220947265625,            1534.958740234375,           1534.5296630859375,               1534.064453125,           1533.9234619140625,           1533.5960693359375,           1533.4993896484375,               1533.138671875,           1532.9959716796875,            1532.604248046875,            1532.604248046875,
        1536.5306396484375,            1536.5306396484375,            1536.4263916015625,             1536.326904296875,             1536.001708984375,             1535.763916015625,           1535.5552978515625,             1535.23583984375,             1534.97021484375,           1534.5401611328125,           1534.0750732421875,             1533.93115234375,             1533.60400390625,           1533.5057373046875,            1533.144287109375,            1533.001220703125,           1532.6090087890625,           1532.6090087890625,
         1536.543701171875,             1536.543701171875,            1536.4427490234375,              1536.34228515625,            1536.0167236328125,            1535.7791748046875,           1535.5714111328125,               1535.251953125,            1534.983642578125,            1534.550537109375,           1534.0848388671875,           1533.9388427734375,           1533.6119384765625,             1533.51123046875,            1533.149658203125,            1533.003662109375,           1532.6112060546875,           1532.6112060546875,
        1536.5550537109375,            1536.5550537109375,            1536.4547119140625,               1536.3525390625,            1536.0279541015625,              1535.79150390625,           1535.5853271484375,             1535.26513671875,             1534.99462890625,           1534.5579833984375,           1534.0909423828125,           1533.9456787109375,             1533.61767578125,             1533.51611328125,             1533.15283203125,                1533.00390625,           1532.6082763671875,           1532.6082763671875,
        1536.5648193359375,            1536.5648193359375,              1536.46435546875,                   1536.359375,            1536.0369873046875,                 1535.80078125,           1535.5968017578125,               1535.275390625,           1535.0028076171875,             1534.56201171875,            1534.093017578125,             1533.95068359375,             1533.62158203125,           1533.5201416015625,           1533.1541748046875,             1533.00341796875,            1532.603271484375,            1532.603271484375,
        1536.5736083984375,            1536.5736083984375,                1536.470703125,             1536.364990234375,              1536.04541015625,            1535.8104248046875,            1535.607666015625,              1535.2822265625,           1535.0059814453125,              1534.5595703125,              1534.0908203125,                  1533.953125,            1533.622314453125,           1533.5218505859375,           1533.1524658203125,           1533.0006103515625,            1532.595947265625,            1532.595947265625,
          1536.58056640625,              1536.58056640625,              1536.47509765625,              1536.37451171875,            1536.0552978515625,             1535.819580078125,           1535.6163330078125,           1535.2850341796875,            1535.003173828125,           1534.5509033203125,           1534.0855712890625,           1533.9530029296875,            1533.620849609375,            1533.519287109375,            1533.145263671875,              1532.9931640625,              1532.5830078125,              1532.5830078125,
         1536.586181640625,             1536.586181640625,            1536.4810791015625,             1536.385498046875,            1536.0655517578125,                1535.826171875,             1535.61962890625,            1535.277587890625,            1534.990478515625,           1534.5350341796875,            1534.072998046875,           1533.9476318359375,            1533.616455078125,            1533.514404296875,            1533.135986328125,           1532.9832763671875,           1532.5689697265625,           1532.5689697265625,
           1536.5908203125,               1536.5908203125,              1536.48876953125,             1536.392822265625,            1536.0731201171875,             1535.826416015625,           1535.6136474609375,           1535.2584228515625,           1534.9686279296875,              1534.5068359375,           1534.0511474609375,             1533.93408203125,           1533.6075439453125,           1533.5069580078125,           1533.1214599609375,           1532.9674072265625,           1532.5516357421875,           1532.5516357421875,
          1536.59619140625,              1536.59619140625,            1536.4964599609375,               1536.3974609375,            1536.0748291015625,            1535.8197021484375,             1535.59228515625,           1535.2152099609375,            1534.929443359375,           1534.4669189453125,               1534.021484375,           1533.9227294921875,            1533.594482421875,           1533.4967041015625,            1533.109130859375,           1532.9539794921875,           1532.5360107421875,           1532.5360107421875,
          1536.57763671875,              1536.57763671875,            1536.4793701171875,            1536.3765869140625,              1536.05224609375,            1535.7904052734375,           1535.5489501953125,            1535.139892578125,            1534.852294921875,           1534.3802490234375,           1533.9461669921875,               1533.873046875,           1533.5562744140625,             1533.46240234375,           1533.0758056640625,           1532.9237060546875,           1532.5052490234375,           1532.5052490234375,
         1536.470947265625,             1536.470947265625,             1536.374267578125,            1536.2760009765625,              1535.96337890625,                     1535.6875,           1535.4227294921875,           1534.9549560546875,           1534.6661376953125,            1534.227294921875,           1533.8385009765625,             1533.76708984375,              1533.4501953125,            1533.374267578125,                1532.98828125,             1532.84423828125,           1532.4239501953125,           1532.4239501953125,
         1536.280517578125,             1536.280517578125,                 1536.16015625,             1536.031982421875,             1535.666748046875,              1535.36376953125,           1535.1097412109375,           1534.6822509765625,            1534.416748046875,           1534.0242919921875,           1533.6695556640625,           1533.5906982421875,            1533.260009765625,           1533.2017822265625,           1532.8372802734375,            1532.696533203125,             1532.27685546875,             1532.27685546875,
        1535.9854736328125,            1535.9854736328125,            1535.8218994140625,             1535.667724609375,             1535.207763671875,            1534.8636474609375,            1534.607177734375,           1534.2249755859375,             1534.00439453125,            1533.669677734375,           1533.3370361328125,               1533.251953125,           1532.9197998046875,             1532.86083984375,              1532.5244140625,           1532.4024658203125,            1531.982177734375,            1531.982177734375,
        1535.6085205078125,            1535.6085205078125,            1535.3919677734375,            1535.1983642578125,              1534.66162109375,            1534.2794189453125,            1534.007080078125,           1533.6239013671875,             1533.41552734375,            1533.108154296875,           1532.7596435546875,              1532.6611328125,             1532.32666015625,           1532.2791748046875,              1531.9208984375,           1531.7945556640625,           1531.3599853515625,           1531.3599853515625,
         1535.177978515625,             1535.177978515625,              1534.91162109375,            1534.6427001953125,            1534.0352783203125,            1533.6339111328125,           1533.3389892578125,             1532.94580078125,           1532.7332763671875,           1532.4029541015625,           1532.0404052734375,                1531.94140625,           1531.5867919921875,            1531.530029296875,            1531.145751953125,            1531.009033203125,           1530.5745849609375,           1530.5745849609375,
        1534.6956787109375,            1534.6956787109375,              1534.35302734375,            1534.0272216796875,             1533.304443359375,            1532.9061279296875,             1532.62548828125,           1532.2144775390625,           1531.9632568359375,           1531.5780029296875,            1531.182861328125,            1531.085693359375,             1530.72607421875,           1530.6595458984375,              1530.2587890625,           1530.1314697265625,              1529.7861328125,              1529.7861328125,
         1534.017822265625,             1534.017822265625,            1533.6458740234375,             1533.224853515625,              1532.47021484375,              1532.07861328125,           1531.7740478515625,            1531.327392578125,             1531.08447265625,            1530.641357421875,           1530.2030029296875,             1530.11767578125,              1529.7607421875,           1529.6893310546875,           1529.3470458984375,                1529.25390625,           1529.0306396484375,           1529.0306396484375,
           1533.0576171875,               1533.0576171875,            1532.6656494140625,             1532.214599609375,            1531.3868408203125,             1531.009521484375,              1530.7626953125,           1530.3013916015625,           1530.0323486328125,             1529.58349609375,           1529.1466064453125,           1529.0665283203125,             1528.74462890625,                 1528.6953125,               1528.431640625,            1528.355224609375,           1528.2386474609375,           1528.2386474609375,
         1531.828369140625,             1531.828369140625,            1531.2872314453125,            1530.8397216796875,            1530.1942138671875,              1529.79736328125,           1529.4884033203125,           1529.0941162109375,            1528.906494140625,           1528.4927978515625,           1528.0823974609375,           1528.0123291015625,           1527.7498779296875,           1527.6993408203125,            1527.537353515625,           1527.4974365234375,           1527.4312744140625,           1527.4312744140625,
         1530.319091796875,             1530.319091796875,             1529.845458984375,            1529.4444580078125,              1528.74658203125,              1528.43017578125,              1528.2470703125,            1527.878662109375,           1527.7152099609375,            1527.364990234375,           1527.0406494140625,           1527.0050048828125,           1526.8123779296875,              1526.7802734375,            1526.665771484375,           1526.6546630859375,             1526.64404296875,             1526.64404296875,
         1528.681396484375,             1528.681396484375,            1528.2818603515625,             1527.893798828125,            1527.3331298828125,            1527.0694580078125,            1526.936279296875,             1526.66455078125,           1526.5057373046875,              1526.2529296875,            1526.058349609375,           1526.0631103515625,             1525.95361328125,           1525.9561767578125,           1525.9005126953125,           1525.8565673828125,             1525.94482421875,             1525.94482421875,
        1526.9971923828125,            1526.9971923828125,               1526.5947265625,              1526.35693359375,               1525.9658203125,             1525.744873046875,           1525.5447998046875,            1525.402587890625,           1525.4197998046875,           1525.3262939453125,           1525.2642822265625,            1525.276123046875,             1525.23291015625,            1525.198486328125,                 1525.1953125,            1525.258544921875,           1525.3629150390625,           1525.3629150390625,
        1525.0338134765625,            1525.0338134765625,              1524.80810546875,              1524.68798828125,            1524.3558349609375,              1524.24658203125,           1524.2655029296875,            1524.243408203125,            1524.247314453125,           1524.3900146484375,              1524.4853515625,            1524.544677734375,           1524.5863037109375,             1524.63134765625,           1524.6942138671875,           1524.6968994140625,           1524.8785400390625,           1524.8785400390625,
        1522.9581298828125,            1522.9581298828125,                1522.818359375,              1522.81884765625,               1522.7509765625,            1522.7322998046875,           1522.7293701171875,            1522.913330078125,                1523.07421875,           1523.3660888671875,              1523.6650390625,           1523.7642822265625,            1523.929931640625,            1523.952880859375,            1524.070556640625,           1524.1412353515625,           1524.3294677734375,           1524.3294677734375,
         1519.895751953125,             1519.895751953125,            1519.9300537109375,             1520.116943359375,            1520.1473388671875,            1520.4036865234375,            1520.535888671875,           1520.9547119140625,           1521.1719970703125,            1521.614501953125,           1522.0572509765625,            1522.266845703125,           1522.6619873046875,           1522.8087158203125,           1523.1265869140625,           1523.2105712890625,            1523.503173828125,            1523.503173828125,
          1516.22900390625,              1516.22900390625,              1516.31396484375,            1516.6824951171875,              1517.19091796875,            1517.5225830078125,           1517.7518310546875,            1518.260986328125,             1518.52783203125,           1519.0999755859375,            1519.584716796875,                1519.81640625,           1520.3223876953125,           1520.5413818359375,            1521.051025390625,             1521.21630859375,               1521.650390625,               1521.650390625,
           1511.7587890625,               1511.7587890625,            1512.1873779296875,            1512.9327392578125,             1513.925537109375,             1514.615966796875,               1514.869140625,           1515.4864501953125,           1515.7767333984375,             1516.38427734375,           1517.0328369140625,           1517.3355712890625,           1517.8714599609375,              1518.0986328125,                 1518.6484375,            1518.818115234375,              1519.2685546875,              1519.2685546875,
              1506.5078125,                  1506.5078125,             1506.999267578125,            1508.1451416015625,             1509.594970703125,               1510.3642578125,            1510.740478515625,                1511.49609375,           1511.8563232421875,           1512.6241455078125,             1513.42431640625,           1513.7965087890625,           1514.5701904296875,             1514.88037109375,            1515.474853515625,           1515.7073974609375,             1516.23095703125,             1516.23095703125,
        1500.5799560546875,            1500.5799560546875,             1501.085693359375,             1501.990966796875,            1503.3902587890625,            1504.4085693359375,            1504.823486328125,           1505.6785888671875,              1506.0927734375,           1506.9425048828125,           1507.8155517578125,            1508.199951171875,            1509.051513671875,            1509.469970703125,            1510.387451171875,           1510.7132568359375,            1511.447509765625,            1511.447509765625,
          1492.72705078125,              1492.72705078125,              1493.27001953125,            1494.2747802734375,             1495.472412109375,              1496.28173828125,            1496.715576171875,             1497.65771484375,           1498.1209716796875,                1498.91015625,            1499.721435546875,           1500.1641845703125,             1501.22509765625,           1501.7249755859375,           1502.7579345703125,           1503.1773681640625,            1504.158935546875,            1504.158935546875,
        1485.2745361328125,            1485.2745361328125,              1485.86865234375,             1486.751708984375,            1487.9615478515625,               1488.6748046875,            1488.980224609375,            1489.549560546875,            1489.903076171875,            1490.716552734375,           1491.5384521484375,            1491.947021484375,               1492.646484375,           1493.1029052734375,           1493.9644775390625,                 1494.3984375,             1495.25341796875,             1495.25341796875,
          1480.39794921875,              1480.39794921875,            1480.8428955078125,            1481.5772705078125,             1482.690185546875,             1483.287353515625,            1483.582275390625,           1484.0858154296875,            1484.359619140625,           1484.8187255859375,               1485.318359375,             1485.62939453125,                1486.19140625,            1486.504150390625,             1487.03271484375,           1487.3499755859375,             1487.97509765625,             1487.97509765625,
        1479.1190185546875,            1479.1190185546875,            1479.4195556640625,              1479.83642578125,            1480.6104736328125,            1481.0587158203125,            1481.301513671875,            1481.651123046875,              1481.8134765625,           1482.1148681640625,           1482.4381103515625,           1482.6114501953125,             1482.95263671875,           1483.1466064453125,           1483.5728759765625,           1483.7655029296875,            1484.123779296875,            1484.123779296875,
         1479.642822265625,             1479.642822265625,            1479.7530517578125,                1479.962890625,             1480.318115234375,             1480.584716796875,           1480.7176513671875,             1480.99267578125,            1481.155517578125,               1481.353515625,              1481.5146484375,           1481.6336669921875,               1481.798828125,            1481.929931640625,           1482.0928955078125,            1482.238525390625,           1482.4771728515625,           1482.4771728515625,
        1481.0211181640625,            1481.0211181640625,            1481.0963134765625,             1481.236083984375,              1481.47998046875,            1481.6864013671875,           1481.7960205078125,             1481.99560546875,             1482.02197265625,              1482.1435546875,           1482.2879638671875,           1482.3731689453125,             1482.51708984375,           1482.5782470703125,            1482.729736328125,           1482.7955322265625,            1482.944580078125,            1482.944580078125,
            1483.005859375,                1483.005859375,             1483.031494140625,             1483.126220703125,            1483.3013916015625,                 1483.45703125,             1483.48095703125,            1483.619873046875,            1483.674560546875,            1483.863037109375,           1484.0247802734375,           1484.0804443359375,           1484.2489013671875,           1484.2945556640625,           1484.4454345703125,             1484.46533203125,              1484.6025390625,              1484.6025390625,
          1485.75634765625,              1485.75634765625,                1485.771484375,                 1485.81640625,                1485.861328125,            1485.9495849609375,             1485.94580078125,            1486.056396484375,           1486.0711669921875,            1486.152099609375,            1486.279541015625,           1486.3131103515625,           1486.4486083984375,           1486.4547119140625,             1486.59326171875,              1486.5966796875,           1486.7315673828125,           1486.7315673828125,
        1489.3626708984375,            1489.3626708984375,             1489.392822265625,            1489.4656982421875,            1489.5179443359375,               1489.5400390625,            1489.543212890625,           1489.5653076171875,           1489.5789794921875,             1489.62158203125,           1489.6497802734375,            1489.639404296875,           1489.6790771484375,            1489.697021484375,            1489.727783203125,              1489.7763671875,           1489.8194580078125,           1489.8194580078125,
        1493.4940185546875,            1493.4940185546875,             1493.558837890625,             1493.614501953125,            1493.7093505859375,             1493.735595703125,           1493.8065185546875,           1493.8182373046875,           1493.8409423828125,             1493.83056640625,             1493.83349609375,           1493.8597412109375,           1493.8458251953125,           1493.8905029296875,            1493.865478515625,           1493.8756103515625,             1493.84716796875,             1493.84716796875,
        1498.1971435546875,            1498.1971435546875,             1498.267333984375,             1498.316162109375,            1498.4119873046875,            1498.4432373046875,             1498.47607421875,           1498.4891357421875,            1498.556396484375,             1498.57275390625,           1498.5694580078125,            1498.635009765625,             1498.63818359375,            1498.648193359375,           1498.6329345703125,                1498.62109375,             1498.61181640625,             1498.61181640625,
           1503.5615234375,               1503.5615234375,            1503.5872802734375,            1503.6302490234375,            1503.6964111328125,            1503.7252197265625,           1503.7628173828125,           1503.7779541015625,               1503.833984375,            1503.833251953125,            1503.856689453125,            1503.910888671875,           1503.9041748046875,           1503.9144287109375,           1503.9144287109375,           1503.8826904296875,            1503.894287109375,            1503.894287109375,
           1509.4736328125,               1509.4736328125,            1509.4508056640625,            1509.4962158203125,            1509.5196533203125,            1509.5516357421875,           1509.5452880859375,             1509.57275390625,             1509.58935546875,             1509.60400390625,              1509.5908203125,           1509.6456298828125,           1509.6544189453125,           1509.6524658203125,            1509.635009765625,           1509.6326904296875,           1509.6160888671875,           1509.6160888671875,
          1516.06494140625,              1516.06494140625,            1516.0618896484375,             1516.072998046875,               1516.0615234375,              1516.07666015625,            1516.066162109375,           1516.0819091796875,           1516.0723876953125,           1516.0755615234375,           1516.0982666015625,            1516.091064453125,               1516.095703125,           1516.0787353515625,           1516.0740966796875,           1516.0474853515625,            1516.053466796875,            1516.053466796875,
         1523.214599609375,             1523.214599609375,            1523.2181396484375,                 1523.21484375,             1523.206298828125,             1523.210693359375,             1523.20458984375,           1523.2052001953125,            1523.195556640625,           1523.1934814453125,              1522.9384765625,           1523.1815185546875,           1523.1888427734375,            1523.146728515625,            1523.162841796875,           1523.1131591796875,           1523.1571044921875,           1523.1571044921875,
         1530.767822265625,             1530.767822265625,            1530.7694091796875,              1530.76904296875,            1530.6634521484375,            1530.6566162109375,           1530.6551513671875,           1530.7584228515625,            1530.630126953125,             1530.62255859375,           1530.0777587890625,                1530.58203125,           1530.5921630859375,           1530.5238037109375,              1530.5615234375,             1530.48779296875,              1530.5712890625,              1530.5712890625,
         1530.767822265625,             1530.767822265625,            1530.7694091796875,              1530.76904296875,            1530.6634521484375,            1530.6566162109375,           1530.6551513671875,           1530.7584228515625,            1530.630126953125,             1530.62255859375,           1530.0777587890625,                1530.58203125,           1530.5921630859375,           1530.5238037109375,              1530.5615234375,             1530.48779296875,              1530.5712890625,              1530.5712890625,
         1530.767822265625,             1530.767822265625,            1530.7694091796875,              1530.76904296875,            1530.6634521484375,            1530.6566162109375,           1530.6551513671875,           1530.7584228515625,            1530.630126953125,             1530.62255859375,           1530.0777587890625,                1530.58203125,           1530.5921630859375,           1530.5238037109375,              1530.5615234375,             1530.48779296875,              1530.5712890625,              1530.5712890625,
         1530.767822265625,             1530.767822265625,            1530.7694091796875,              1530.76904296875,            1530.6634521484375,            1530.6566162109375,           1530.6551513671875,           1530.7584228515625,            1530.630126953125,             1530.62255859375,           1530.0777587890625,                1530.58203125,           1530.5921630859375,           1530.5238037109375,              1530.5615234375,             1530.48779296875,              1530.5712890625,              1530.5712890625,
    };

   
    const size_t Nz = in.ssp_quad.depths_m.size();
    const size_t Nr = in.ssp_quad.ranges.size();

    if (ssp_c_matrix.size() != Nz * Nr) {
        throw std::runtime_error(
            "ssp_c_matrix 尺寸不匹配: 期望 " + std::to_string(Nz) + "x" + std::to_string(Nr) +
            "=" + std::to_string(Nz * Nr) + "，实际 " + std::to_string(ssp_c_matrix.size()));
    }

    in.ssp_quad.c_mps = ssp_c_matrix;

    return in;
}


int main() {
    #ifdef _WIN32
        SetConsoleOutputCP(CP_UTF8);
        SetConsoleCP(CP_UTF8);
    #endif
    
        const int num_profiles = 32;
    
        // 输出目录：test_teds_parallel_outputs
        const std::filesystem::path out_dir = "test_teds_parallel_qssp_outputs";
        std::error_code ec;
        std::filesystem::create_directories(out_dir, ec);
        if(ec) {
            std::cerr << "创建输出目录失败: " << out_dir.string() << " : " << ec.message() << "\n";
            return 2;
        }
    
        std::vector<tedsbellhop::TL2DJob> jobs;
        jobs.reserve(num_profiles);
    
        std::cout << "启动 " << num_profiles << " 个并行计算任务...\n";
    
        for (int i = 0; i < num_profiles; ++i) {
            auto in = create_base_input_from_user_matrix();
    
            // 为每个任务创建一个独特的输入（示例：改变声源深度）
            in.pos.source_depths_m = {static_cast<float>(20 + i * 50)};
            in.title = "TEDSbellhop Parallel Test - Profile " + std::to_string(i);
    
            std::cout << "  - 启动剖面 " << i << " (声源深度: " << in.pos.source_depths_m[0] << "m)\n";
            jobs.push_back(tedsbellhop::start_tl_2d(in));
        }
    
        std::cout << "\n所有任务已启动，开始轮询进度：\n";
    
        int completed_count = 0;
        std::vector<bool> job_done(num_profiles, false);
    
        while (completed_count < num_profiles) {
            std::string progress_line = "进度: ";
            completed_count = 0;
    
            for (int i = 0; i < num_profiles; ++i) {
                if (!job_done[i]) {
                    if (jobs[i].ready()) {
                        job_done[i] = true;
                    }
                }
                if(job_done[i]) completed_count++;
    
                int p = jobs[i].progress();
                progress_line += "P" + std::to_string(i) + ":";
                if (p < 0) progress_line += "--";
                else if (p < 10) progress_line += "  " + std::to_string(p);
                else if (p < 100) progress_line += " " + std::to_string(p);
                else progress_line += std::to_string(p);
                progress_line += "% | ";
            }
    
            std::cout << "\r" << progress_line << std::flush;
            std::this_thread::sleep_for(std::chrono::milliseconds(10));
        }
    
        std::cout << "\n\n所有任务已完成。正在获取结果并保存图片...\n";
    
        bool all_ok = true;
        for (int i = 0; i < num_profiles; ++i) {
            try {
                auto result = jobs[i].get();
                std::cout << "  - 剖面 " << i << " 成功: 网格 " << result.width << "x" << result.height << "\n";
    
                const std::filesystem::path png_path = out_dir / ("profile_" + std::to_string(i) + ".png");
                auto se = result.tl_db;
                //for (auto& data : se)
                //    data = 80 - data;
                if(!tl_png::write_tl_png(png_path.string(), result.width, result.height, se)) {
                    std::cerr << "    保存 PNG 失败: " << png_path.string() << "\n";
                    all_ok = false;
                } else {
                    std::cout << "    已保存: " << png_path.string() << "\n";
                }
    
            } catch (const std::exception& e) {
                std::cerr << "  - 剖面 " << i << " 失败: " << e.what() << "\n";
                all_ok = false;
            }
        }
    
        if (all_ok) {
            std::cout << "\n所有剖面均计算成功！输出目录: " << out_dir.string() << "\n";
            return 0;
        } else {
            std::cerr << "\n部分剖面计算/保存失败。输出目录: " << out_dir.string() << "\n";
            return 1;
        }
    }